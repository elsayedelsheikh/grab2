<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4" main_tree_to_execute="MainTree">
  <BehaviorTree ID="MainTree">
    <KeepRunningUntilFailure> 
      <Sequence>
        <SubTree ID="GoToHomePose"/>
        <ReactiveFallback>
          <DetectObject pregrasp="{pregrasp_pose}" grasp="{grasp_pose}"/>
          <SubTree ID="LookAround"/>
        </ReactiveFallback>
        <SubTree ID="GoToHomePose"/>
        <SubTree ID="Pick" pre="{pregrasp_pose}" item="{grasp_pose}"/>
        <SubTree ID="GoToHomePose"/>
        <SubTree ID="GoToToyBox"/>
      </Sequence>
    </KeepRunningUntilFailure> 
  </BehaviorTree>

  <BehaviorTree ID="LookAround">
    <Sequence>
      <!-- Retract joints configuration -->
      <SaySomething message="Looking for a toy"/>
      <SubTree ID="MoveTo" target="0.35;0;0.65;1;0;0;0"/>
      <SetJointTrajectoryGoal trajectory="{trajectory_msg}"/>
      <Move trajectory="{trajectory_msg}"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Pick">
    <Sequence>
      <SubTree ID="MoveTo" target="{pre}"/>
      <Grip pose="0.04"/>
      <SubTree ID="MoveTo" target="{item}"/>
      <Grip pose="0.02"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="GoToA">
    <Sequence>
      <Script code=" target:='-0.34;0.3;0.6;1.0;0.0;0.0;0.0' " />
      <Plan target_ik="{target}" trajectory="{trajectory_msg}"/>
      <Move trajectory="{trajectory_msg}"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="GoToHomePose">
    <Sequence>
      <Plan target_ik="0.35;0;0.6;1;0;0;0" trajectory="{trajectory_msg}"/>
      <Move trajectory="{trajectory_msg}"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="GoToToyBox">
    <Sequence>
      <Script code=" target:='0.34;-0.3;0.6;1.0;0.0;0.0;0.0' " />
      <Plan target_ik="{target}" trajectory="{trajectory_msg}"/>
      <Move trajectory="{trajectory_msg}"/>
      <Grip pose="0.04"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="MoveTo">
    <Sequence>
      <Plan target_ik="{target}" trajectory="{trajectory_msg}"/>
      <Move trajectory="{trajectory_msg}"/>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="Move" editable="true">
      <input_port name="trajectory"/>
    </Action>
    <Action ID="SaySomething" editable="true">
      <input_port name="message"/>
    </Action>
    <Action ID="SetJointTrajectoryGoal" editable="true">
      <input_port name="trajectory"/>
    </Action>
  </TreeNodesModel>

</root>
